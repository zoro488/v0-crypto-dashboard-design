# ğŸ”„ CHRONOS - ValidaciÃ³n Completa del Sistema
# Workflow para validaciÃ³n integral del sistema con tests avanzados

name: ğŸ”„ Full System Validation

on:
  schedule:
    # Ejecutar diariamente a las 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      validation_level:
        description: 'Nivel de validaciÃ³n'
        required: true
        default: 'standard'
        type: choice
        options:
          - 'quick'      # Solo lint y type-check
          - 'standard'   # Lint, type-check, unit tests
          - 'full'       # Todo incluyendo E2E y anÃ¡lisis de seguridad
      create_issue_on_failure:
        description: 'Crear issue si falla'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # Matriz de validaciÃ³n
  # ============================================================================
  validation-matrix:
    name: ğŸ“‹ Preparar ValidaciÃ³n
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      run_lint: ${{ steps.matrix.outputs.run_lint }}
      run_typecheck: ${{ steps.matrix.outputs.run_typecheck }}
      run_unit_tests: ${{ steps.matrix.outputs.run_unit_tests }}
      run_e2e: ${{ steps.matrix.outputs.run_e2e }}
      run_security: ${{ steps.matrix.outputs.run_security }}
      run_data_validation: ${{ steps.matrix.outputs.run_data_validation }}

    steps:
      - name: ğŸ”§ Configurar matriz de validaciÃ³n
        id: matrix
        run: |
          LEVEL="${{ github.event.inputs.validation_level || 'standard' }}"
          
          echo "run_lint=true" >> $GITHUB_OUTPUT
          echo "run_typecheck=true" >> $GITHUB_OUTPUT
          
          if [[ "$LEVEL" == "quick" ]]; then
            echo "run_unit_tests=false" >> $GITHUB_OUTPUT
            echo "run_e2e=false" >> $GITHUB_OUTPUT
            echo "run_security=false" >> $GITHUB_OUTPUT
            echo "run_data_validation=false" >> $GITHUB_OUTPUT
          elif [[ "$LEVEL" == "standard" ]]; then
            echo "run_unit_tests=true" >> $GITHUB_OUTPUT
            echo "run_e2e=false" >> $GITHUB_OUTPUT
            echo "run_security=false" >> $GITHUB_OUTPUT
            echo "run_data_validation=true" >> $GITHUB_OUTPUT
          else
            echo "run_unit_tests=true" >> $GITHUB_OUTPUT
            echo "run_e2e=true" >> $GITHUB_OUTPUT
            echo "run_security=true" >> $GITHUB_OUTPUT
            echo "run_data_validation=true" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # ValidaciÃ³n de cÃ³digo
  # ============================================================================
  code-validation:
    name: ğŸ” ValidaciÃ³n de CÃ³digo
    runs-on: ubuntu-latest
    needs: validation-matrix
    timeout-minutes: 15
    permissions:
      contents: read
    outputs:
      lint_passed: ${{ steps.lint.outputs.passed }}
      typecheck_passed: ${{ steps.typecheck.outputs.passed }}
      format_passed: ${{ steps.format.outputs.passed }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ” ESLint
        id: lint
        if: needs.validation-matrix.outputs.run_lint == 'true'
        run: |
          if pnpm lint; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… ESLint passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ ESLint failed"
          fi
        continue-on-error: true

      - name: ğŸ“ TypeScript Check
        id: typecheck
        if: needs.validation-matrix.outputs.run_typecheck == 'true'
        run: |
          if pnpm type-check; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… TypeScript passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ TypeScript failed"
          fi
        continue-on-error: true

      - name: ğŸ¨ Format Check
        id: format
        run: |
          if pnpm prettier --check "**/*.{ts,tsx,js,jsx,json,md}"; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Format check passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Format check failed"
          fi
        continue-on-error: true

  # ============================================================================
  # Tests unitarios
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Tests Unitarios
    runs-on: ubuntu-latest
    needs: [validation-matrix, code-validation]
    if: needs.validation-matrix.outputs.run_unit_tests == 'true'
    timeout-minutes: 20
    permissions:
      contents: read
    outputs:
      tests_passed: ${{ steps.tests.outputs.passed }}
      coverage: ${{ steps.tests.outputs.coverage }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Ejecutar tests con cobertura
        id: tests
        run: |
          if pnpm test --passWithNoTests --coverage --json --outputFile=test-results.json; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi
          
          # Extraer cobertura si existe
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=N/A" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        env:
          CI: true

      - name: ğŸ“Š Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage
          path: |
            coverage/
            test-results.json
          retention-days: 14

  # ============================================================================
  # ValidaciÃ³n de datos (lÃ³gica de negocio)
  # ============================================================================
  data-validation:
    name: ğŸ“Š ValidaciÃ³n de Datos
    runs-on: ubuntu-latest
    needs: validation-matrix
    if: needs.validation-matrix.outputs.run_data_validation == 'true'
    timeout-minutes: 15
    permissions:
      contents: read
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¥ Instalar dependencias Python
        run: |
          pip install pandas numpy

      - name: ğŸ“Š Validar archivos CSV
        id: validate
        run: |
          python << 'EOF'
          import pandas as pd
          import os
          import sys
          
          csv_dir = 'csv'
          errors = []
          passed = True
          
          print("ğŸ“Š Validando archivos CSV del sistema CHRONOS...")
          print("=" * 50)
          
          if not os.path.exists(csv_dir):
              print("âš ï¸ Directorio CSV no encontrado - omitiendo validaciÃ³n")
              sys.exit(0)
          
          csv_files = [f for f in os.listdir(csv_dir) if f.endswith('.csv')]
          
          if not csv_files:
              print("âš ï¸ No hay archivos CSV para validar")
              sys.exit(0)
          
          print(f"ğŸ“ Encontrados {len(csv_files)} archivos CSV\n")
          
          for csv_file in csv_files:
              filepath = os.path.join(csv_dir, csv_file)
              try:
                  df = pd.read_csv(filepath)
                  rows = len(df)
                  cols = len(df.columns)
                  
                  # Validaciones especÃ­ficas por tipo de archivo
                  validation_errors = []
                  
                  if 'ventas' in csv_file.lower():
                      required_cols = ['cliente', 'cantidad', 'precio']
                      for col in required_cols:
                          if not any(col in c.lower() for c in df.columns):
                              validation_errors.append(f"Falta columna requerida: {col}")
                  
                  if validation_errors:
                      print(f"  âš ï¸ {csv_file}: {rows} filas, {cols} columnas")
                      for err in validation_errors:
                          print(f"      â””â”€ {err}")
                      passed = False
                  else:
                      print(f"  âœ… {csv_file}: {rows} filas, {cols} columnas")
                      
              except Exception as e:
                  errors.append(f'{csv_file}: {e}')
                  print(f"  âŒ {csv_file}: Error - {e}")
                  passed = False
          
          print("\n" + "=" * 50)
          if errors:
              print(f"âŒ {len(errors)} errores encontrados")
              sys.exit(1)
          elif not passed:
              print("âš ï¸ ValidaciÃ³n completada con advertencias")
              sys.exit(0)
          else:
              print("âœ… Todos los archivos CSV son vÃ¡lidos")
              sys.exit(0)
          EOF
          
          if [ $? -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ğŸ’¼ Validar lÃ³gica de negocio
        run: |
          python << 'EOF'
          import sys
          
          print("\nğŸ’¼ Validando lÃ³gica de negocio CHRONOS...")
          print("=" * 50)
          
          # Tests de distribuciÃ³n de ventas
          test_cases = [
              {'precioVenta': 10000, 'precioCompra': 6300, 'precioFlete': 500, 'cantidad': 10},
              {'precioVenta': 15000, 'precioCompra': 9000, 'precioFlete': 600, 'cantidad': 5},
              {'precioVenta': 8000, 'precioCompra': 5000, 'precioFlete': 400, 'cantidad': 20},
          ]
          
          passed = 0
          for tc in test_cases:
              # FÃ³rmulas correctas del sistema CHRONOS
              expected_boveda = tc['precioCompra'] * tc['cantidad']
              expected_fletes = tc['precioFlete'] * tc['cantidad']
              expected_utilidades = (tc['precioVenta'] - tc['precioCompra'] - tc['precioFlete']) * tc['cantidad']
              expected_total = tc['precioVenta'] * tc['cantidad']
              
              # Verificar que la suma de distribuciones sea igual al total
              suma_distribuciones = expected_boveda + expected_fletes + expected_utilidades
              
              if suma_distribuciones == expected_total:
                  passed += 1
                  print(f"  âœ… Test passed: cantidad={tc['cantidad']}, total={expected_total}")
                  print(f"      â””â”€ BÃ³veda: {expected_boveda}, Fletes: {expected_fletes}, Utilidades: {expected_utilidades}")
              else:
                  print(f"  âŒ Test failed: La suma ({suma_distribuciones}) != total ({expected_total})")
          
          print(f"\nğŸ“Š Business Logic: {passed}/{len(test_cases)} tests passed")
          
          if passed == len(test_cases):
              print("âœ… Todas las validaciones de lÃ³gica de negocio pasaron")
              sys.exit(0)
          else:
              print("âŒ Algunas validaciones fallaron")
              sys.exit(1)
          EOF

  # ============================================================================
  # AnÃ¡lisis de seguridad
  # ============================================================================
  security-scan:
    name: ğŸ”’ AnÃ¡lisis de Seguridad
    runs-on: ubuntu-latest
    needs: validation-matrix
    if: needs.validation-matrix.outputs.run_security == 'true'
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ Audit de dependencias
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: ğŸ” Buscar secretos expuestos
        uses: trufflesecurity/trufflehog@v3.88.2
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  # ============================================================================
  # Tests E2E
  # ============================================================================
  e2e-validation:
    name: ğŸ­ Tests E2E
    runs-on: ubuntu-latest
    needs: [validation-matrix, code-validation, unit-tests]
    if: needs.validation-matrix.outputs.run_e2e == 'true'
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Instalar Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true

      - name: ğŸš€ Ejecutar tests E2E
        run: |
          pnpm start &
          sleep 15
          pnpm test:e2e || true
        env:
          CI: true
          SKIP_ENV_VALIDATION: true

      - name: ğŸ“¸ Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report
          path: playwright-report/
          retention-days: 14

  # ============================================================================
  # Reporte consolidado
  # ============================================================================
  consolidated-report:
    name: ğŸ“‹ Reporte Consolidado
    runs-on: ubuntu-latest
    needs: [code-validation, unit-tests, data-validation, security-scan, e2e-validation]
    if: always()
    permissions:
      issues: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“Š Generar reporte
        id: report
        run: |
          echo "# ğŸ”„ Reporte de ValidaciÃ³n Completa del Sistema CHRONOS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Nivel de validaciÃ³n:** ${{ github.event.inputs.validation_level || 'standard' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Resultados por Ãrea" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ãrea | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.code-validation.outputs.lint_passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.code-validation.outputs.typecheck_passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.code-validation.outputs.format_passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.outputs.tests_passed == 'true' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cobertura | ${{ needs.unit-tests.outputs.coverage || 'N/A' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Validation | ${{ needs.data-validation.outputs.validation_passed == 'true' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-validation.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Determinar estado general
          if [[ "${{ needs.code-validation.outputs.lint_passed }}" == "false" ]] || \
             [[ "${{ needs.code-validation.outputs.typecheck_passed }}" == "false" ]] || \
             [[ "${{ needs.unit-tests.outputs.tests_passed }}" == "false" ]]; then
            echo "overall_status=failure" >> $GITHUB_OUTPUT
          else
            echo "overall_status=success" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš¨ Crear issue si falla
        if: |
          steps.report.outputs.overall_status == 'failure' && 
          (github.event.inputs.create_issue_on_failure == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ ValidaciÃ³n del Sistema Fallida - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ğŸ”„ ValidaciÃ³n AutomÃ¡tica del Sistema CHRONOS
            
            La validaciÃ³n programada ha detectado problemas:
            
            ### ğŸ“Š Resultados
            
            | Ãrea | Estado |
            |------|--------|
            | ESLint | ${{ needs.code-validation.outputs.lint_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }} |
            | TypeScript | ${{ needs.code-validation.outputs.typecheck_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }} |
            | Unit Tests | ${{ needs.unit-tests.outputs.tests_passed == 'true' && 'âœ… Passed' || 'âŒ Failed' }} |
            
            ### ğŸ”— Enlaces
            
            - [Ver workflow completo](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### ğŸ“ Acciones recomendadas
            
            1. Revisar los logs del workflow
            2. Ejecutar tests localmente: \`pnpm test\`
            3. Corregir errores de lint: \`pnpm lint --fix\`
            4. Verificar tipos: \`pnpm type-check\`
            
            ---
            ğŸ¤– *Issue creado automÃ¡ticamente por GitHub Actions*
            `;
            
            // Buscar issue existente similar
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'system-validation,automated'
            });
            
            const existingIssue = issues.find(i => i.title.includes('ValidaciÃ³n del Sistema Fallida'));
            
            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ Nueva ejecuciÃ³n fallida\n\n${body}`
              });
              console.log(`Comentario aÃ±adido al issue #${existingIssue.number}`);
            } else {
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['system-validation', 'automated', 'bug']
              });
              console.log(`Issue creado: #${newIssue.number}`);
            }
