# ðŸ¤– CHRONOS - Agente de CorrecciÃ³n AutomÃ¡tica con Copilot
# Workflow que se activa con labels especÃ­ficos para correcciÃ³n automÃ¡tica de issues

name: ðŸ¤– Copilot Auto-Fix Agent

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'NÃºmero del issue a corregir'
        required: true
        type: number
      fix_type:
        description: 'Tipo de correcciÃ³n'
        required: true
        type: choice
        options:
          - 'lint'
          - 'tests'
          - 'types'
          - 'all'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================================================
  # Determinar tipo de correcciÃ³n
  # ============================================================================
  determine-fix:
    name: ðŸ” Analizar Issue
    runs-on: ubuntu-latest
    if: |
      contains(github.event.label.name, 'copilot-fix') || 
      contains(github.event.label.name, 'auto-fix') ||
      github.event_name == 'workflow_dispatch'
    permissions:
      issues: read
    outputs:
      fix_type: ${{ steps.analyze.outputs.fix_type }}
      issue_number: ${{ steps.analyze.outputs.issue_number }}
      branch_name: ${{ steps.analyze.outputs.branch_name }}

    steps:
      - name: ðŸ” Analizar issue y determinar tipo de correcciÃ³n
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber, fixType, branchName;
            
            if (context.eventName === 'workflow_dispatch') {
              issueNumber = ${{ github.event.inputs.issue_number || 0 }};
              fixType = '${{ github.event.inputs.fix_type || 'all' }}';
            } else {
              issueNumber = context.payload.issue.number;
              const labels = context.payload.issue.labels.map(l => l.name);
              
              if (labels.includes('fix:lint')) {
                fixType = 'lint';
              } else if (labels.includes('fix:tests')) {
                fixType = 'tests';
              } else if (labels.includes('fix:types')) {
                fixType = 'types';
              } else {
                fixType = 'all';
              }
            }
            
            branchName = `auto-fix/issue-${issueNumber}`;
            
            core.setOutput('fix_type', fixType);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('branch_name', branchName);
            
            console.log(`Issue: #${issueNumber}`);
            console.log(`Fix type: ${fixType}`);
            console.log(`Branch: ${branchName}`);

  # ============================================================================
  # Aplicar correcciones
  # ============================================================================
  apply-fixes:
    name: ðŸ”§ Aplicar Correcciones
    runs-on: ubuntu-latest
    needs: determine-fix
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: ðŸ“ Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸŒ¿ Crear branch de correcciÃ³n
        run: |
          git checkout -b ${{ needs.determine-fix.outputs.branch_name }}

      - name: ðŸ”§ Aplicar fix de ESLint
        if: needs.determine-fix.outputs.fix_type == 'lint' || needs.determine-fix.outputs.fix_type == 'all'
        run: |
          echo "ðŸ”§ Aplicando ESLint fixes..."
          pnpm lint --fix || true
          
          echo "ðŸŽ¨ Aplicando Prettier..."
          pnpm prettier --write "**/*.{ts,tsx,js,jsx,json,css,md}" || true

      - name: ðŸ§ª Ejecutar y verificar tests
        if: needs.determine-fix.outputs.fix_type == 'tests' || needs.determine-fix.outputs.fix_type == 'all'
        run: |
          echo "ðŸ§ª Ejecutando tests..."
          pnpm test --passWithNoTests 2>&1 | tee test-output.txt || true
          
          # Analizar errores de tests
          if grep -q "FAIL" test-output.txt; then
            echo "âŒ Hay tests fallidos - se necesita revisiÃ³n manual"
          else
            echo "âœ… Tests pasaron correctamente"
          fi
        env:
          CI: true

      - name: ðŸ“ Verificar tipos TypeScript
        if: needs.determine-fix.outputs.fix_type == 'types' || needs.determine-fix.outputs.fix_type == 'all'
        run: |
          echo "ðŸ“ Verificando tipos TypeScript..."
          pnpm type-check 2>&1 | tee typecheck-output.txt || true

      - name: ðŸ“Š Verificar si hay cambios
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Cambios detectados:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No hay cambios para commit"
          fi

      - name: ðŸ’¾ Commit cambios
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add -A
          ISSUE_NUM="${{ needs.determine-fix.outputs.issue_number }}"
          FIX_TYPE="${{ needs.determine-fix.outputs.fix_type }}"
          git commit -m "fix: auto-fix para issue #${ISSUE_NUM}" \
            -m "Tipo de correcciÃ³n: ${FIX_TYPE}" \
            -m "Cambios aplicados:" \
            -m "- ESLint fixes" \
            -m "- Prettier formatting" \
            -m "- VerificaciÃ³n de tipos" \
            -m "" \
            -m "Ref: #${ISSUE_NUM}"

      - name: ðŸš€ Push branch
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ needs.determine-fix.outputs.branch_name }} --force

      - name: ðŸ“ Crear Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: auto-fix para issue #${{ needs.determine-fix.outputs.issue_number }}'
          title: 'ðŸ¤– Auto-fix: Correcciones para #${{ needs.determine-fix.outputs.issue_number }}'
          body: |
            ## ðŸ¤– Pull Request Automatizado
            
            Este PR fue creado automÃ¡ticamente por el Copilot Auto-Fix Agent.
            
            ### ðŸ“‹ Issue Relacionado
            
            Fixes #${{ needs.determine-fix.outputs.issue_number }}
            
            ### ðŸ”§ Tipo de CorrecciÃ³n
            
            **${{ needs.determine-fix.outputs.fix_type }}**
            
            ### âœ… Cambios Aplicados
            
            - [x] ESLint fixes aplicados
            - [x] Prettier formatting aplicado
            - [x] VerificaciÃ³n de tipos realizada
            
            ### ðŸ“Š VerificaciÃ³n AutomÃ¡tica
            
            Los workflows de CI/CD se ejecutarÃ¡n automÃ¡ticamente para validar estos cambios.
            
            ### ðŸ“ Notas
            
            - Este PR requiere revisiÃ³n antes de hacer merge
            - Los tests deben pasar antes de aprobar
            - Revisar los cambios para asegurar que son correctos
            
            ---
            ðŸ¤– *Generado automÃ¡ticamente por GitHub Actions - CHRONOS System*
          branch: ${{ needs.determine-fix.outputs.branch_name }}
          base: main
          labels: |
            automated
            auto-fix
            needs-review

      - name: ðŸ’¬ Comentar en issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.determine-fix.outputs.issue_number }};
            const hasChanges = '${{ steps.check_changes.outputs.has_changes }}' === 'true';
            const fixType = '${{ needs.determine-fix.outputs.fix_type }}';
            const branchName = '${{ needs.determine-fix.outputs.branch_name }}';
            
            let body;
            
            if (hasChanges) {
              body = `## ðŸ¤– Copilot Auto-Fix Agent
              
              âœ… **Correcciones aplicadas exitosamente!**
              
              ### ðŸ“‹ Detalles
              
              | Campo | Valor |
              |-------|-------|
              | Tipo de fix | \`${fixType}\` |
              | Branch | \`${branchName}\` |
              | Estado | âœ… PR Creado |
              
              ### ðŸ”— Siguiente paso
              
              Se ha creado un Pull Request con las correcciones. Por favor revisa los cambios y aprueba el PR si son correctos.
              
              [Ver workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ---
              ðŸ¤– *Generado automÃ¡ticamente*`;
            } else {
              body = `## ðŸ¤– Copilot Auto-Fix Agent
              
              â„¹ï¸ **No se detectaron cambios necesarios**
              
              El anÃ¡lisis no encontrÃ³ correcciones automÃ¡ticas que aplicar para el tipo \`${fixType}\`.
              
              ### ðŸ“ Opciones
              
              1. Revisar manualmente el cÃ³digo
              2. Ejecutar con tipo de fix diferente
              3. Solicitar ayuda adicional
              
              [Ver workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ---
              ðŸ¤– *Generado automÃ¡ticamente*`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });

  # ============================================================================
  # NotificaciÃ³n de finalizaciÃ³n
  # ============================================================================
  notify-completion:
    name: ðŸ“¬ Notificar FinalizaciÃ³n
    runs-on: ubuntu-latest
    needs: [determine-fix, apply-fixes]
    if: always()
    permissions: {}

    steps:
      - name: ðŸ“Š Generar resumen
        run: |
          echo "# ðŸ¤– Copilot Auto-Fix Agent - Resumen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Detalles de EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | #${{ needs.determine-fix.outputs.issue_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo de Fix | ${{ needs.determine-fix.outputs.fix_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ needs.determine-fix.outputs.branch_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Estado | ${{ needs.apply-fixes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "â° Completado: $(date)" >> $GITHUB_STEP_SUMMARY
