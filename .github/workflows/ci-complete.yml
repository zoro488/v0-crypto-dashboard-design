name: ðŸš€ CI/CD Complete - CHRONOS System

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: 'true'
      run_validation:
        description: 'Run data validation'
        required: false
        default: 'true'

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '10'

jobs:
  # ============================================================================
  # JOB 1: Code Quality & Linting
  # ============================================================================
  quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—‚ï¸ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”Ž Run ESLint
        run: pnpm lint
        continue-on-error: true

      - name: ðŸ“Š TypeScript check
        run: pnpm type-check

      - name: ðŸ“ Format check
        run: pnpm prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: true

  # ============================================================================
  # JOB 2: Unit Tests
  # ============================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—‚ï¸ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Run Jest tests
        run: pnpm test --coverage --maxWorkers=2
        env:
          CI: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-tests
        continue-on-error: true

  # ============================================================================
  # JOB 3: Build Test
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—‚ï¸ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build application
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: true

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  # ============================================================================
  # JOB 4: E2E Tests with Playwright
  # ============================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build]
    if: github.event_name == 'push' || github.event.inputs.run_e2e == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸŽ­ Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next/

      - name: ðŸš€ Start development server
        run: |
          pnpm dev &
          sleep 10
          curl -I http://localhost:3000 || echo "Server not ready yet"
        env:
          SKIP_ENV_VALIDATION: true

      - name: ðŸŽ­ Run Playwright tests
        run: pnpm test:e2e
        env:
          CI: true

      - name: ðŸ“¸ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

  # ============================================================================
  # JOB 5: Data Validation
  # ============================================================================
  data-validation:
    name: ðŸ“Š Data Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event.inputs.run_validation == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ðŸ“¦ Install Python dependencies
        run: |
          cd automation
          pip install -r requirements.txt || pip install pandas firebase-admin python-dotenv

      - name: ðŸ” Run data consistency validator
        run: |
          cd automation
          python data_consistency_validator.py
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
        continue-on-error: true

      - name: ðŸ“Š Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: automation/reports/
          retention-days: 30

  # ============================================================================
  # JOB 6: Security Scan
  # ============================================================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ”’ Run npm audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: ðŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  # ============================================================================
  # JOB 7: Performance Tests
  # ============================================================================
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: .next/

      - name: ðŸš€ Start server
        run: |
          pnpm start &
          sleep 15
        env:
          SKIP_ENV_VALIDATION: true

      - name: âš¡ Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  # ============================================================================
  # JOB 8: Auto-fix and Create PR
  # ============================================================================
  auto-fix:
    name: ðŸ”§ Auto-fix Issues
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality, unit-tests, e2e-tests, data-validation]
    if: failure() && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”§ Auto-fix ESLint issues
        run: pnpm lint --fix
        continue-on-error: true

      - name: ðŸ”§ Auto-format code
        run: pnpm prettier --write "**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: true

      - name: ðŸ Setup Python for auto-healing
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ¤– Run auto-healing agent
        run: |
          cd automation
          pip install -r requirements.txt || pip install pandas firebase-admin python-dotenv openai
          python autonomous_test_agent.py
        continue-on-error: true

      - name: ðŸ“ Create Pull Request with fixes
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: auto-fix issues detected by CI'
          title: 'ðŸ¤– Auto-fix: CI detected issues'
          body: |
            ## ðŸ¤– Automated Fix

            This PR was automatically created by the CI/CD pipeline to fix detected issues:

            - âœ… ESLint fixes applied
            - âœ… Code formatting applied
            - âœ… Auto-healing agent ran

            ### Changes
            - Linting errors fixed
            - Code formatted with Prettier
            - Data consistency issues resolved

            **Please review before merging.**
          branch: auto-fix/${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            ci-fix
            needs-review

  # ============================================================================
  # JOB 9: Notification Summary
  # ============================================================================
  notify:
    name: ðŸ“¬ Notify Results
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, build, e2e-tests, data-validation, security, performance]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Validation | ${{ needs.data-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pipeline completed at $(date)" >> $GITHUB_STEP_SUMMARY
