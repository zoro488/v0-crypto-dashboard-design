# ðŸ’¼ Business Logic Verification - Sistema CHRONOS
# Verifica la lÃ³gica de negocio crÃ­tica: distribuciÃ³n GYA, estados de pago, cÃ¡lculo de capital

name: ðŸ’¼ Business Logic Verification

on:
  push:
    branches: [main, develop]
    paths:
      - 'app/lib/**'
      - 'app/components/panels/**'
      - 'app/components/modals/**'
      - '__tests__/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: business-logic-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Verificar FÃ³rmulas de DistribuciÃ³n GYA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-gya-formulas:
    name: ðŸ’° Verificar FÃ³rmulas GYA
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Verificar implementaciÃ³n de distribuciÃ³n GYA
        run: |
          echo "## ðŸ’° VerificaciÃ³n de FÃ³rmulas GYA (Ganancia, Yield, AsignaciÃ³n)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### FÃ³rmula Correcta:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "montoBovedaMonte = precioCompraUnidad Ã— cantidad    // COSTO" >> $GITHUB_STEP_SUMMARY
          echo "montoFletes = precioFlete Ã— cantidad                // FLETE" >> $GITHUB_STEP_SUMMARY
          echo "montoUtilidades = (precioVenta - precioCompra - flete) Ã— cantidad  // GANANCIA" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Buscar implementaciones de distribuciÃ³n
        run: |
          echo "### Implementaciones encontradas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Buscar en servicios
          if grep -rn "bovedaMonte\|fleteUtilidad\|utilidad" app/lib/services/ 2>/dev/null; then
            echo "âœ… DistribuciÃ³n implementada en servicios" >> $GITHUB_STEP_SUMMARY
            grep -rn "bovedaMonte\|precioCompra.*cantidad" app/lib/services/ 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || true
          fi
          
          # Buscar en componentes
          if grep -rn "distribucion\|bovedaMonte" app/components/panels/BentoVentas.tsx 2>/dev/null; then
            echo "âœ… DistribuciÃ³n mostrada en BentoVentas" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ BentoVentas puede no mostrar distribuciÃ³n GYA" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ§® Verificar cÃ¡lculos en modales
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VerificaciÃ³n en Modales:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar CreateVentaModalPremium
          if grep -q "precioVenta\|precioCompra\|cantidad" app/components/modals/CreateVentaModalPremium.tsx 2>/dev/null; then
            echo "âœ… CreateVentaModalPremium tiene campos de cÃ¡lculo" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ CreateVentaModalPremium falta campos de cÃ¡lculo" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Verificar Estados de Pago
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-payment-states:
    name: ðŸ’³ Verificar Estados de Pago
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Verificar implementaciÃ³n de estados
        run: |
          echo "## ðŸ’³ VerificaciÃ³n de Estados de Pago" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estados esperados:" >> $GITHUB_STEP_SUMMARY
          echo "- **Completo**: 100% pagado, distribuciÃ³n total a 3 bancos" >> $GITHUB_STEP_SUMMARY
          echo "- **Parcial**: DistribuciÃ³n proporcional" >> $GITHUB_STEP_SUMMARY
          echo "- **Pendiente**: Solo histÃ³rico, no afecta capital" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Buscar implementaciÃ³n de estados
        run: |
          echo "### Implementaciones encontradas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Buscar tipos de estado
          if grep -rn "estadoPago.*completo\|parcial\|pendiente" app/ 2>/dev/null | head -5; then
            echo "âœ… Estados de pago definidos" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Verificar definiciÃ³n de estados de pago" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verificar lÃ³gica proporcional
          if grep -rn "proporcion\|montoPagado.*precioTotal" app/ 2>/dev/null | head -3; then
            echo "âœ… CÃ¡lculo proporcional implementado" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Verificar cÃ¡lculo proporcional para pagos parciales" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Verificar CÃ¡lculo de Capital Bancario
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-bank-capital:
    name: ðŸ¦ Verificar Capital Bancario
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Verificar fÃ³rmula de capital
        run: |
          echo "## ðŸ¦ VerificaciÃ³n de CÃ¡lculo de Capital" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### FÃ³rmula Correcta:" >> $GITHUB_STEP_SUMMARY
          echo "\`capitalActual = historicoIngresos - historicoGastos\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Importante:** historicoIngresos y historicoGastos son acumulativos y NUNCA disminuyen" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Buscar implementaciÃ³n en store
        run: |
          echo "### ImplementaciÃ³n en Store (Zustand):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "app/lib/store/useAppStore.ts" ]; then
            if grep -q "historicoIngresos\|historicoGastos\|capitalActual" app/lib/store/useAppStore.ts 2>/dev/null; then
              echo "âœ… Campos de capital definidos en store" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Verificar campos de capital en store" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -q "saldo\|bancos" app/lib/store/useAppStore.ts 2>/dev/null; then
              echo "âœ… Estado de bancos en store" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ðŸ” Verificar 7 bancos/bÃ³vedas
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VerificaciÃ³n de 7 Bancos/BÃ³vedas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Banco | ID | Moneda |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| BÃ³veda Monte | boveda_monte | MXN |" >> $GITHUB_STEP_SUMMARY
          echo "| BÃ³veda USA | boveda_usa | USD |" >> $GITHUB_STEP_SUMMARY
          echo "| Profit | profit | MXN |" >> $GITHUB_STEP_SUMMARY
          echo "| Leftie | leftie | MXN |" >> $GITHUB_STEP_SUMMARY
          echo "| Azteca | azteca | MXN |" >> $GITHUB_STEP_SUMMARY
          echo "| Flete Sur | flete_sur | MXN |" >> $GITHUB_STEP_SUMMARY
          echo "| Utilidades | utilidades | MXN |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Tests de LÃ³gica de Negocio
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  business-logic-tests:
    name: ðŸ§ª Tests LÃ³gica de Negocio
    runs-on: ubuntu-latest
    needs: [verify-gya-formulas, verify-payment-states, verify-bank-capital]
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Ejecutar tests de lÃ³gica de negocio
        run: |
          # Ejecutar tests relacionados con lÃ³gica de negocio
          pnpm test --passWithNoTests --testPathPattern="(schemas|store|utils)" || true
        env:
          CI: true

      - name: ðŸ“Š Verificar schemas Zod
        run: |
          echo "## ðŸ“‹ Schemas de ValidaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "app/lib/schemas" ]; then
            echo "### Schemas encontrados:" >> $GITHUB_STEP_SUMMARY
            find app/lib/schemas -name "*.ts" -exec basename {} \; | while read f; do
              echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âš ï¸ Directorio de schemas no encontrado" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Reporte Final
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  final-report:
    name: ðŸ“‹ Reporte Final
    runs-on: ubuntu-latest
    needs: [verify-gya-formulas, verify-payment-states, verify-bank-capital, business-logic-tests]
    if: always()
    steps:
      - name: ðŸ“‹ Generar reporte
        run: |
          echo "# ðŸ’¼ Reporte de LÃ³gica de Negocio" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaciÃ³n | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| FÃ³rmulas GYA | ${{ needs.verify-gya-formulas.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Estados de Pago | ${{ needs.verify-payment-states.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Capital Bancario | ${{ needs.verify-bank-capital.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.business-logic-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
