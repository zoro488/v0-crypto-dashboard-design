# ðŸ¤– Agent Session Tasks - Sistema CHRONOS
# Tareas automatizadas de agente para verificaciÃ³n y resoluciÃ³n

name: ðŸ¤– Agent Session Tasks

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Tipo de tarea del agente'
        required: true
        type: choice
        options:
          - verify-all
          - fix-components
          - integrate-3d
          - test-business-logic
          - full-audit

concurrency:
  group: agent-session-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: AnÃ¡lisis Inicial del Agente
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  agent-analysis:
    name: ðŸ” AnÃ¡lisis del Agente
    runs-on: ubuntu-latest
    outputs:
      task_type: ${{ steps.determine.outputs.task }}
      priority: ${{ steps.determine.outputs.priority }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Determinar tipo de tarea
        id: determine
        run: |
          # Determinar tarea basado en input o labels
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            task="${{ github.event.inputs.task_type }}"
          else
            # Analizar labels del issue
            labels="${{ join(github.event.issue.labels.*.name, ',') }}"
            if echo "$labels" | grep -qi "3d\|spline"; then
              task="integrate-3d"
            elif echo "$labels" | grep -qi "bug\|fix"; then
              task="fix-components"
            elif echo "$labels" | grep -qi "test\|verify"; then
              task="verify-all"
            else
              task="verify-all"
            fi
          fi
          
          echo "task=$task" >> $GITHUB_OUTPUT
          echo "priority=medium" >> $GITHUB_OUTPUT
          echo "ðŸ¤– Tarea determinada: $task"

      - name: ðŸ“‹ Registrar sesiÃ³n del agente
        run: |
          echo "## ðŸ¤– SesiÃ³n del Agente Iniciada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tarea**: ${{ steps.determine.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: VerificaciÃ³n Completa
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-all:
    name: âœ… VerificaciÃ³n Completa
    runs-on: ubuntu-latest
    needs: agent-analysis
    if: needs.agent-analysis.outputs.task_type == 'verify-all' || needs.agent-analysis.outputs.task_type == 'full-audit'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Verificar componentes
        run: |
          echo "## âœ… VerificaciÃ³n de Componentes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Contar componentes por tipo
          panels=$(find app/components/panels -name "*.tsx" | wc -l)
          modals=$(find app/components/modals -name "*.tsx" | wc -l)
          comp_3d=$(find app/components/3d -name "*.tsx" | wc -l)
          viz=$(find app/components/visualizations -name "*.tsx" | wc -l)
          widgets=$(find app/components/widgets -name "*.tsx" | wc -l)
          
          echo "| Tipo | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Paneles | $panels |" >> $GITHUB_STEP_SUMMARY
          echo "| Modales | $modals |" >> $GITHUB_STEP_SUMMARY
          echo "| 3D | $comp_3d |" >> $GITHUB_STEP_SUMMARY
          echo "| Visualizaciones | $viz |" >> $GITHUB_STEP_SUMMARY
          echo "| Widgets | $widgets |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§ª Ejecutar tests
        run: pnpm test --passWithNoTests
        env:
          CI: true
        continue-on-error: true

      - name: ðŸ” TypeScript check
        run: pnpm tsc --noEmit 2>&1 | tail -20 || true
        continue-on-error: true

      - name: ðŸ” Lint check
        run: pnpm lint 2>&1 | tail -20 || true
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: IntegraciÃ³n 3D
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  integrate-3d:
    name: ðŸŽ® Integrar Componentes 3D
    runs-on: ubuntu-latest
    needs: agent-analysis
    if: needs.agent-analysis.outputs.task_type == 'integrate-3d' || needs.agent-analysis.outputs.task_type == 'full-audit'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Analizar integraciÃ³n actual
        run: |
          echo "## ðŸŽ® Estado de IntegraciÃ³n 3D" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analizar cada panel
          for panel in app/components/panels/Bento*.tsx; do
            name=$(basename $panel .tsx)
            has_3d=$(grep -c "from.*3d\|Spline" $panel 2>/dev/null || echo "0")
            has_viz=$(grep -c "from.*visualizations" $panel 2>/dev/null || echo "0")
            
            if [ "$has_3d" -gt "0" ]; then
              echo "âœ… **$name**: IntegraciÃ³n 3D activa" >> $GITHUB_STEP_SUMMARY
            elif [ "$has_viz" -gt "0" ]; then
              echo "ðŸ”¶ **$name**: Solo visualizaciones Canvas" >> $GITHUB_STEP_SUMMARY
            else
              echo "âšª **$name**: Sin componentes 3D - PENDIENTE" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: ðŸ“‹ Generar plan de integraciÃ³n
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Plan de IntegraciÃ³n 3D" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Componentes 3D disponibles para integrar:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Listar componentes 3D principales
          echo "| Componente | Uso Recomendado |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| PremiumSplineOrb | Dashboard, IA - Orbe de estado |" >> $GITHUB_STEP_SUMMARY
          echo "| FloatingAIOrb | Widget flotante IA |" >> $GITHUB_STEP_SUMMARY
          echo "| AnalyticsGlobe3D | Clientes, Distribuidores |" >> $GITHUB_STEP_SUMMARY
          echo "| WorkflowVisualizer3D | Ã“rdenes, Ventas |" >> $GITHUB_STEP_SUMMARY
          echo "| AIBrainVisualizer | Panel IA |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Fix Components
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  fix-components:
    name: ðŸ”§ Corregir Componentes
    runs-on: ubuntu-latest
    needs: agent-analysis
    if: needs.agent-analysis.outputs.task_type == 'fix-components' || needs.agent-analysis.outputs.task_type == 'full-audit'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Detectar problemas comunes
        run: |
          echo "## ðŸ”§ AnÃ¡lisis de Problemas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Buscar console.log (debe usar logger)
          console_logs=$(grep -rn "console\.log\|console\.error" app/components/ 2>/dev/null | wc -l)
          echo "### Uso de console (debe usar logger):" >> $GITHUB_STEP_SUMMARY
          if [ "$console_logs" -gt "0" ]; then
            echo "âš ï¸ Encontrados $console_logs usos de console. Deben usar logger." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Sin usos directos de console" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Buscar any en TypeScript
          any_usage=$(grep -rn ": any\|as any" app/ 2>/dev/null | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Uso de 'any' (prohibido):" >> $GITHUB_STEP_SUMMARY
          if [ "$any_usage" -gt "0" ]; then
            echo "âš ï¸ Encontrados $any_usage usos de 'any'. Deben usar tipos especÃ­ficos." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Sin usos de 'any'" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Buscar useEffect sin cleanup
          effects_without_cleanup=$(grep -A5 "useEffect.*=>" app/components/ 2>/dev/null | grep -c "return ()" || echo "0")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Memory Leaks potenciales:" >> $GITHUB_STEP_SUMMARY
          echo "Verificar useEffect con listeners que tengan cleanup" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Test Business Logic
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-business-logic:
    name: ðŸ’¼ Test LÃ³gica de Negocio
    runs-on: ubuntu-latest
    needs: agent-analysis
    if: needs.agent-analysis.outputs.task_type == 'test-business-logic' || needs.agent-analysis.outputs.task_type == 'full-audit'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Tests de schemas
        run: pnpm test --passWithNoTests --testPathPattern="schemas" || true
        env:
          CI: true

      - name: ðŸ§ª Tests de store
        run: pnpm test --passWithNoTests --testPathPattern="store" || true
        env:
          CI: true

      - name: ðŸ“Š Verificar fÃ³rmulas GYA
        run: |
          echo "## ðŸ’¼ VerificaciÃ³n de LÃ³gica GYA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Buscar implementaciÃ³n de distribuciÃ³n
          if grep -rn "bovedaMonte.*=.*precioCompra\|fletes.*=.*flete\|utilidad.*=.*venta.*compra" app/ 2>/dev/null; then
            echo "âœ… FÃ³rmulas de distribuciÃ³n encontradas" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Verificar implementaciÃ³n de fÃ³rmulas GYA" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: Reporte Final del Agente
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  agent-report:
    name: ðŸ“‹ Reporte del Agente
    runs-on: ubuntu-latest
    needs: [agent-analysis, verify-all, integrate-3d, fix-components, test-business-logic]
    if: always()
    steps:
      - name: ðŸ“‹ Generar reporte final
        run: |
          echo "# ðŸ¤– Reporte Final de SesiÃ³n del Agente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resumen de Tareas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tarea | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AnÃ¡lisis | ${{ needs.agent-analysis.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaciÃ³n | ${{ needs.verify-all.result == 'success' && 'âœ…' || needs.verify-all.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IntegraciÃ³n 3D | ${{ needs.integrate-3d.result == 'success' && 'âœ…' || needs.integrate-3d.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fix Components | ${{ needs.fix-components.result == 'success' && 'âœ…' || needs.fix-components.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Business Logic | ${{ needs.test-business-logic.result == 'success' && 'âœ…' || needs.test-business-logic.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Completado: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
