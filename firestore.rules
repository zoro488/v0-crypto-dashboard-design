rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    //  REGLAS DE PRODUCCIN - CHRONOS SYSTEM
    // ltima actualizaci贸n: 2025-01-27
    // Sincronizado con CSVs de datos reales (783 registros)
    
    // ===================================================================
    // FUNCIONES DE VALIDACIN
    // ===================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    function isValidMonto() {
      return request.resource.data.monto is number && request.resource.data.monto >= 0;
    }
    
    function isValidCantidad() {
      return request.resource.data.cantidad is number && request.resource.data.cantidad > 0;
    }
    
    function isValidBancoId(bancoId) {
      return bancoId in ['boveda_monte', 'boveda_usa', 'profit', 'leftie', 'azteca', 'flete_sur', 'utilidades'];
    }
    
    function isValidTipoMovimiento() {
      return request.resource.data.tipoMovimiento in ['ingreso', 'gasto', 'transferencia_entrada', 'transferencia_salida', 'abono_cliente', 'pago_distribuidor'];
    }

    // ===================================================================
    // COLECCIN: BANCOS (Configuraci贸n de los 7 bancos/b贸vedas)
    // IDs: boveda_monte, boveda_usa, profit, leftie, azteca, flete_sur, utilidades
    // ===================================================================
    match /bancos/{bancoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['nombre', 'tipo'])
        && isValidBancoId(bancoId);
      allow update: if isAuthenticated();
      allow delete: if false; // Los bancos no se pueden eliminar
    }

    // ===================================================================
    // COLECCIN: MOVIMIENTOS (Unificado para todos los bancos)
    // Reemplaza: boveda_monte, boveda_usa, profit, leftie, azteca, flete_sur, utilidades, gastos_abonos
    // ===================================================================
    match /movimientos/{movimientoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['bancoId', 'tipoMovimiento', 'monto', 'fecha']) 
        && isValidMonto()
        && isValidTipoMovimiento();
      allow update: if isAuthenticated() && isValidMonto();
      allow delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: TRANSFERENCIAS (Entre bancos)
    // ===================================================================
    match /transferencias/{transferenciaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['bancoOrigenId', 'bancoDestinoId', 'monto', 'fecha'])
        && isValidMonto();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: ABONOS (Pagos de clientes/distribuidores)
    // ===================================================================
    match /abonos/{abonoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['tipo', 'entidadId', 'monto', 'bancoDestino'])
        && isValidMonto();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: INGRESOS
    // ===================================================================
    match /ingresos/{ingresoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['monto', 'concepto', 'bancoDestino'])
        && isValidMonto();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: GASTOS
    // ===================================================================
    match /gastos/{gastoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['monto', 'concepto', 'bancoOrigen'])
        && isValidMonto();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: VENTAS (96 registros desde ventas.csv)
    // ===================================================================
    match /ventas/{ventaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['cliente', 'fecha', 'cantidad'])
        && isValidCantidad();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: CLIENTES (31 registros desde clientes.csv)
    // ===================================================================
    match /clientes/{clienteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: DISTRIBUIDORES (6 registros)
    // PACMAN, Q-MAYA, A/X, CH-MONTE, VALLE-MONTE, Q-MAYA-MP
    // ===================================================================
    match /distribuidores/{distribuidorId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: ORDENES_COMPRA (9 registros desde ordenes_compra.csv)
    // ===================================================================
    match /ordenes_compra/{ordenId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['distribuidor', 'fecha', 'cantidad'])
        && isValidCantidad();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: GASTOS_ABONOS (302 registros - hist贸rico legacy)
    // ===================================================================
    match /gastos_abonos/{gastoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['fecha', 'valor', 'destino']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: ALMACEN (Inventario de productos - 9 registros)
    // ===================================================================
    match /almacen/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    match /almacen_productos/{productoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    match /almacen_entradas/{entradaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['fecha', 'cantidad'])
        && isValidCantidad();
      allow update, delete: if isAuthenticated();
    }

    match /almacen_salidas/{salidaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['fecha', 'cantidad'])
        && isValidCantidad();
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: CORTES BANCARIOS (Hist贸rico de cortes)
    // ===================================================================
    match /cortes_bancarios/{corteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['bancoId', 'fechaInicio']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: LOGS (Auditor铆a del sistema - inmutable)
    // ===================================================================
    match /logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false; // 锔 Los logs son INMUTABLES
    }

    // ===================================================================
    // COLECCIONES DEL DASHBOARD
    // ===================================================================
    match /dashboard_totales/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    match /dashboard_paneles/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: USUARIOS (Perfil de usuario - solo el propietario)
    // ===================================================================
    match /usuarios/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ===================================================================
    // COLECCIN: CONFIGURACIN
    // ===================================================================
    match /configuracion/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ===================================================================
    // TABLAS POR BANCO - INGRESOS
    // Colecciones: boveda_monte_ingresos, boveda_usa_ingresos, etc.
    // ===================================================================
    match /boveda_monte_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /boveda_usa_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /profit_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /leftie_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /azteca_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /flete_sur_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /utilidades_ingresos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ===================================================================
    // TABLAS POR BANCO - GASTOS
    // Colecciones: boveda_monte_gastos, boveda_usa_gastos, etc.
    // ===================================================================
    match /boveda_monte_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /boveda_usa_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /profit_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /leftie_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /azteca_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /flete_sur_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /utilidades_gastos/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ===================================================================
    // TABLAS POR BANCO - CORTES (RF Actual hist贸rico)
    // Colecciones: boveda_monte_cortes, boveda_usa_cortes, etc.
    // ===================================================================
    match /boveda_monte_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /boveda_usa_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /profit_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /leftie_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /azteca_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /flete_sur_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    match /utilidades_cortes/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ===================================================================
    // REGLA POR DEFECTO - DENEGAR TODO LO DEMS
    // 锔 CRTICO: No cambiar esta regla
    // ===================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
