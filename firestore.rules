rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES HELPER
    // ============================================================
    
    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica si el documento contiene los campos requeridos
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================================
    // REGLAS POR COLECCIÓN
    // ============================================================
    
    // BANCOS - Control financiero
    // Solo lectura para usuarios autenticados, escritura restringida
    match /bancos/{bancoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['nombre', 'capitalActual', 'createdAt']);
      allow update: if isAuthenticated();
      allow delete: if false; // No permitir eliminar bancos
    }
    
    // ÓRDENES DE COMPRA
    match /ordenesCompra/{ordenId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && hasRequiredFields(['distribuidor', 'producto', 'cantidad', 'fecha']);
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // VENTAS
    match /ventas/{ventaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && hasRequiredFields(['cliente', 'producto', 'cantidad', 'fecha']);
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // DISTRIBUIDORES
    match /distribuidores/{distribuidorId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // CLIENTES
    match /clientes/{clienteId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // PRODUCTOS
    match /productos/{productoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ALMACÉN
    match /almacen/{productoId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ============================================================
    // REGLA CATCH-ALL - Denegar acceso a colecciones no definidas
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================================
    // ⚠️ MODO DESARROLLO - Descomentar para testing local
    // ============================================================
    // ADVERTENCIA: Las siguientes reglas permiten acceso completo
    // sin autenticación. Solo usar en desarrollo local.
    // 
    // match /{document=**} {
    //   allow read, write: if true;
    // }
  }
}
