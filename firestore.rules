rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    //  REGLAS DE PRODUCCIN - CHRONOS SYSTEM
    // ltima actualizaci贸n: 2025-11-26
    // Sincronizado con CSVs de datos reales
    
    // ===================================================================
    // FUNCIONES DE VALIDACIN
    // ===================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    function isValidMonto() {
      return request.resource.data.monto is number;
    }

    // ===================================================================
    // COLECCIN: BANCOS (Configuraci贸n de los 7 bancos/b贸vedas)
    // IDs: boveda_monte, boveda_usa, profit, leftie, azteca, flete_sur, utilidades
    // ===================================================================
    match /bancos/{bancoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre', 'tipo']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: MOVIMIENTOS (Unificado para todos los bancos)
    // Reemplaza: boveda_monte, boveda_usa, profit, leftie, azteca, flete_sur, utilidades, gastos_abonos
    // ===================================================================
    match /movimientos/{movimientoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['bancoId', 'tipoMovimiento', 'monto', 'fecha']) 
        && isValidMonto();
      allow update: if isAuthenticated() && isValidMonto();
      allow delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: VENTAS (96 registros desde ventas.csv)
    // ===================================================================
    match /ventas/{ventaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['cliente', 'fecha', 'totalVenta']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: CLIENTES (31 registros desde clientes.csv)
    // ===================================================================
    match /clientes/{clienteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: DISTRIBUIDORES (6 registros)
    // PACMAN, Q-MAYA, A/X, CH-MONTE, VALLE-MONTE, Q-MAYA-MP
    // ===================================================================
    match /distribuidores/{distribuidorId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: ORDENES_COMPRA (9 registros desde ordenes_compra.csv)
    // ===================================================================
    match /ordenes_compra/{ordenId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['distribuidor', 'fecha', 'costoTotal', 'cantidad']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: GASTOS_ABONOS (302 registros - hist贸rico de gastos/abonos)
    // ===================================================================
    match /gastos_abonos/{gastoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(['fecha', 'valor', 'destino']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: ALMACEN (Inventario de productos - 9 registros)
    // ===================================================================
    match /almacen/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['cantidad']);
      allow update, delete: if isAuthenticated();
    }

    match /almacen_productos/{productoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['nombre', 'stock']);
      allow update, delete: if isAuthenticated();
    }

    match /almacen_entradas/{entradaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['fecha', 'cantidad']);
      allow update, delete: if isAuthenticated();
    }

    match /almacen_salidas/{salidaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['fecha', 'cantidad']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: CORTES BANCARIOS (Hist贸rico de cortes)
    // ===================================================================
    match /cortes_bancarios/{corteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && hasRequiredFields(['bancoId', 'fechaInicio']);
      allow update, delete: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: LOGS (Auditor铆a del sistema - inmutable)
    // ===================================================================
    match /logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ===================================================================
    // COLECCIONES DEL DASHBOARD
    // ===================================================================
    match /dashboard_totales/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    match /dashboard_paneles/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ===================================================================
    // COLECCIN: USUARIOS (Perfil de usuario)
    // ===================================================================
    match /usuarios/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ===================================================================
    // COLECCIN: CONFIGURACIN
    // ===================================================================
    match /configuracion/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ===================================================================
    // REGLA POR DEFECTO - DENEGAR TODO LO DEMS
    // ===================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
